worker_processes 1;

events {
    worker_connections 1024;
}

http {

    resolver 127.0.0.11 valid=30s;
    # Для веб-сокетов (нужно для React/Next.js dev server)
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # CORS Map
    map $http_origin $cors_origin {
        default "$http_origin";
        "~^http://localhost(:[0-9]+)?$" "$http_origin";
        "~^http://127.0.0.1(:[0-9]+)?$" "$http_origin";
    }

    server {
        listen 8000;

        # Скрываем заголовки от бэкендов, чтобы Nginx управлял CORS
        proxy_hide_header 'Access-Control-Allow-Origin';
        proxy_hide_header 'Access-Control-Allow-Methods';
        proxy_hide_header 'Access-Control-Allow-Headers';
        proxy_hide_header 'Access-Control-Allow-Credentials';

        # ==========================================
        # API USERS (Используем имя сервиса user_service)
        # ==========================================
        location /api/users/ {
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' "$cors_origin";
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH';
                add_header 'Access-Control-Allow-Credentials' 'true';
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Origin, Accept, X-Requested-With';
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
            }

            add_header 'Access-Control-Allow-Origin' "$cors_origin" always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Origin, Accept, X-Requested-With' always;

            # В docker-compose сервис называется user_service, порт внутри контейнера 80
            proxy_pass http://user_service:80/users/;
        }

        # ==========================================
        # API TEAMS (Используем имя сервиса teams_service)
        # ==========================================
        location /api/teams/ {
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' "$cors_origin";
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH';
                add_header 'Access-Control-Allow-Credentials' 'true';
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Origin, Accept, X-Requested-With';
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' "$cors_origin" always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Origin, Accept, X-Requested-With' always;

            # Сервис teams_service, порт внутри 80
            proxy_pass http://teams_service:80/teams/;
        }

        # ==========================================
        # API MATCHES (Используем имя сервиса matches_service)
        # ==========================================
        location /api/matches/ {
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' "$cors_origin";
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH';
                add_header 'Access-Control-Allow-Credentials' 'true';
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Origin, Accept, X-Requested-With';
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' "$cors_origin" always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Origin, Accept, X-Requested-With' always;

            # Сервис matches_service, порт внутри 80
            proxy_pass http://matches_service:80/matches/;
        }

        # ==========================================
        # API BETS (Используем имя сервиса bets_service)
        # ==========================================
        location /api/bets/ {
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' "$cors_origin";
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH';
                add_header 'Access-Control-Allow-Credentials' 'true';
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Origin, Accept, X-Requested-With';
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' "$cors_origin" always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Origin, Accept, X-Requested-With' always;

            # Сервис bets_service, порт внутри 80
            proxy_pass http://bets_service:80/bets/;
        }

        location /api/token {
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' "$cors_origin";
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH';
                add_header 'Access-Control-Allow-Credentials' 'true';
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Origin, Accept, X-Requested-With';
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' "$cors_origin" always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Origin, Accept, X-Requested-With' always;

            # Токен тоже в user_service
            proxy_pass http://user_service:80/token;
        }

        # ==========================================
        # FRONTEND (Проксируем на контейнер frontend)
        # ==========================================
        location / {
            # Здесь мы перенаправляем запрос на сервис frontend, порт 3000
            proxy_pass http://frontend:3000;
            
            # Заголовки для поддержки WebSocket (Hot Reloading в React)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
        }
    }
}