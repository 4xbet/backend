# Отчет о Code Review

## Общее резюме
Проект демонстрирует базовую реализацию микросервисной архитектуры с использованием FastAPI и Docker. Однако, в ходе анализа был выявлен ряд критических уязвимостей и проблем, которые необходимо устранить для обеспечения стабильности, безопасности и масштабируемости системы.

Основные проблемы включают:
- **Безопасность:** Использование жестко закодированных учетных данных, отсутствие надлежащей авторизации и валидации данных.
- **Качество кода:** Дублирование кода, недостаточная обработка ошибок и отсутствие следования принципам SOLID.
- **Производительность:** Потенциальные проблемы с производительностью из-за неэффективных запросов к базе данных и отсутствия кэширования.
- **Надежность:** Отсутствие атомарности операций в некоторых сервисах, что может привести к несогласованности данных.

В целом, проект требует серьезной доработки для приведения его в соответствие с лучшими практиками разработки и обеспечения безопасности.

## Детальный разбор
### docker-compose.yml
- **Строка:** 6, 21, 36, 51, 67
- **Критичность:** Высокая
- **Проблема:** Жестко закодированные учетные данные для баз данных и `SECRET_KEY` в переменных окружения.
- **Рекомендация:** Использовать Docker Secrets или переменные окружения, управляемые через `.env` файл, который не будет коммититься в репозиторий, для управления конфиденциальной информацией.

- **Строка:** 9, 24, 39, 54, 69
- **Критичность:** Средняя
- **Проблема:** Все сервисы работают под пользователем `root` внутри контейнеров.
- **Рекомендация:** Создать непривилегированного пользователя в Dockerfile для каждого сервиса и запускать приложения от его имени.

### install_db.sh
- **Строка:** 4
- **Критичность:** Высокая
- **Проблема:** Жестко закодированный пароль для пользователя `postgres`.
- **Рекомендация:** Использовать переменные окружения или другой безопасный механизм для установки пароля.

- **Строка:** 1-8
- **Критичность:** Высокая
- **Проблема:** Скрипт использует `sudo` и устанавливает `postgresql` непосредственно на хост-машину, что противоречит идее использования Docker для изоляции окружения.
- **Рекомендация:** Удалить этот скрипт. Вся настройка баз данных должна производиться через `docker-compose.yml` и, при необходимости, через скрипты инициализации, которые запускаются внутри контейнеров PostgreSQL.

### api_gateway/nginx.conf
- **Строка:** 30, 50, 70, 90, 110
- **Критичность:** Низкая
- **Проблема:** Дублирование заголовков CORS в каждом `location` блоке.
- **Рекомендация:** Вынести общие заголовки CORS в блок `server` для уменьшения дублирования и упрощения конфигурации.

- **Строка:** 10
- **Критичность:** Средняя
- **Проблема:** `map $http_origin $cors_origin` разрешает любой источник, что может быть небезопасно.
- **Рекомендация:** Создать "белый список" доверенных доменов, чтобы ограничить доступ к API.

### user_service/app/main.py
- **Строка:** 28
- **Критичность:** Низкая
- **Проблема:** Отсутствие валидации сложности пароля при создании пользователя.
- **Рекомендация:** Добавить валидацию сложности пароля, например, с использованием регулярных выражений или библиотеки, такой как `passlib`.

- **Строка:** 90
- **Критичность:** Высокая
- **Проблема:** Эндпоинт `PATCH /users/{user_id}/wallet` не имеет авторизации. Любой пользователь может изменить баланс кошелька другого пользователя, зная его ID.
- **Рекомендация:** Добавить проверку прав доступа. Только администраторы или сам пользователь (в зависимости от бизнес-логики) должны иметь возможность изменять баланс кошелька.

### bets_service/app/main.py
- **Строка:** 45-78
- **Критичность:** Высокая
- **Проблема:** Отсутствие атомарности операции создания ставки. Если после создания ставки в базе данных (`crud.create_bet`) произойдет сбой при обновлении баланса кошелька, система останется в несогласованном состоянии (ставка есть, а деньги не списаны).
- **Рекомендация:** Реализовать транзакционность для всей операции. Если какая-либо часть операции завершается неудачно, все изменения должны быть отменены.

- **Строка:** 81
- **Критичность:** Средняя
- **Проблема:** Эндпоинт `GET /bets/` не имеет пагинации, что может привести к проблемам с производительностью при большом количестве ставок.
- **Рекомендация:** Добавить параметры `skip` и `limit` для пагинации результатов.

### matches_service/app/main.py
- **Строка:** 66, 80
- **Критичность:** Средняя
- **Проблема:** Общая обработка исключений (`except Exception as e`) скрывает реальные причины ошибок и возвращает общее сообщение "Internal server error".
- **Рекомендация:** Добавить более специфичную обработку ошибок, чтобы возвращать осмысленные сообщения об ошибках и логировать детали для отладки.

- **Строка:** 32
- **Критичность:** Средняя
- **Проблема:** Отсутствие пагинации для эндпоинта `GET /matches/`.
- **Рекомендация:** Добавить параметры `skip` и `limit` для пагинации.

### teams_service/app/main.py
- **Строка:** 36
- **Критичность:** Низкая
- **Проблема:** При создании команды (`create_team`) возвращается `None` в случае, если команда с таким именем уже существует, и затем в эндпоинте генерируется исключение `HTTPException`.
- **Рекомендация:** Переместить проверку на существование команды и генерацию исключения в `crud` слой, чтобы сделать код более чистым и соответствующим принципу единственной ответственности (Single Responsibility Principle).

- **Строка:** 58
- **Критичность:** Средняя
- **Проблема:** Отсутствие защиты от удаления команды, которая участвует в матчах.
- **Рекомендация:** Добавить проверку, что команда не связана с какими-либо матчами, перед ее удалением.

## Дополнительный детальный анализ

### frontend/package.json
- **Строка:** 6
- **Критичность:** Средняя
- **Проблема:** Отсутствие скриптов для тестирования. Отсутствие тестов делает невозможным проверку корректности работы компонентов и бизнес-логики на стороне клиента.
- **Рекомендация:** Интегрировать фреймворки для тестирования, такие как Jest и React Testing Library, и добавить скрипты для запуска тестов.

### frontend/src/app/register/page.tsx
- **Строка:** 16-25
- **Критичность:** Низкая
- **Проблема:** Ручное управление состоянием формы и отсутствие валидации на стороне клиента. Это приводит к большему количеству кода и худшему пользовательскому опыту.
- **Рекомендация:** Использовать библиотеки для управления формами, такие как `react-hook-form` в связке с `zod` для валидации, чтобы упростить код и обеспечить немедленную обратную связь пользователю.

### frontend/src/store/useAuthStore.ts
- **Строка:** 60-78
- **Критичность:** Высокая
- **Проблема:** В функции `initialize` не проверяется срок действия (`exp`) токена. Это означает, что пользователь останется в системе, даже если срок действия токена истек, что является серьезной уязвимостью безопасности.
- **Рекомендация:** Добавить проверку срока действия токена при инициализации. Если токен истек, необходимо вызывать функцию `logout`.

### user_service/app/crud.py
- **Строка:** 45-50
- **Критичность:** Высокая
- **Проблема:** Операции создания пользователя и его кошелька не являются атомарными. Если после создания пользователя произойдет сбой, кошелек не будет создан, что приведет к несогласованности данных.
- **Рекомендация:** Объединить создание пользователя и кошелька в одну транзакцию.

- **Строка:** 53-58
- **Критичность:** Высокая
- **Проблема:** Отсутствие блокировки при обновлении баланса кошелька. Это может привести к состоянию гонки (race condition), когда несколько одновременных запросов могут привести к неверному расчету баланса.
- **Рекомендация:** Использовать `SELECT ... FOR UPDATE` для блокировки строки кошелька на время транзакции, чтобы обеспечить корректное обновление баланса.

### user_service/app/auth.py
- **Строка:** 8
- **Критичность:** Высокая
- **Проблема:** Использование жестко закодированного `SECRET_KEY` по умолчанию. Если переменная окружения не установлена, будет использоваться небезопасный ключ.
- **Рекомендация:** Удалить значение по умолчанию и генерировать ошибку при запуске, если `SECRET_KEY` не установлен.

### bets_service/app/crud.py
- **Строка:** 56-70
- **Критичность:** Высокая
- **Проблема:** Функция `settle_bets` обновляет статусы ставок на "won", но не производит выплату выигрышей на кошельки пользователей. Основная бизнес-логика не реализована.
- **Рекомендация:** Добавить логику для расчета и выплаты выигрышей. Необходимо получить все "выигравшие" ставки, рассчитать сумму выигрыша (`amount_staked * odds_on_bet`) и вызвать `user_service` для пополнения кошельков соответствующих пользователей.

- **Строка:** 56-70
- **Критичность:** Высокая
- **Проблема:** Операция по расчету ставок не является атомарной. Если в процессе обновления статусов или выплаты выигрышей произойдет сбой, система останется в несогласованном состоянии.
- **Рекомендация:** Обеспечить атомарность всей операции. Все обновления статусов и выплаты должны быть частью одной транзакции. Если какая-либо часть операции завершается неудачно, все изменения должны быть отменены.
