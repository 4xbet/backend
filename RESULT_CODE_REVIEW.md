# Отчет о Code Review

## Общее резюме
Проект демонстрирует базовую реализацию микросервисной архитектуры с использованием FastAPI и Docker. Однако, в ходе анализа был выявлен ряд критических уязвимостей и проблем, которые необходимо устранить для обеспечения стабильности, безопасности и масштабируемости системы.

Основные проблемы включают:
- **Безопасность:** Использование жестко закодированных учетных данных, отсутствие надлежащей авторизации и валидации данных.
- **Качество кода:** Дублирование кода, недостаточная обработка ошибок и отсутствие следования принципам SOLID.
- **Производительность:** Потенциальные проблемы с производительностью из-за неэффективных запросов к базе данных и отсутствия кэширования.
- **Надежность:** Отсутствие атомарности операций в некоторых сервисах, что может привести к несогласованности данных.

В целом, проект требует серьезной доработки для приведения его в соответствие с лучшими практиками разработки и обеспечения безопасности.

## Детальный разбор
### docker-compose.yml
- **Строка:** 6, 21, 36, 51, 67
- **Критичность:** Высокая
- **Проблема:** Жестко закодированные учетные данные для баз данных и `SECRET_KEY` в переменных окружения.
- **Рекомендация:** Использовать Docker Secrets или переменные окружения, управляемые через `.env` файл, который не будет коммититься в репозиторий, для управления конфиденциальной информацией.

- **Строка:** 9, 24, 39, 54, 69
- **Критичность:** Средняя
- **Проблема:** Все сервисы работают под пользователем `root` внутри контейнеров.
- **Рекомендация:** Создать непривилегированного пользователя в Dockerfile для каждого сервиса и запускать приложения от его имени.

### install_db.sh
- **Строка:** 4
- **Критичность:** Высокая
- **Проблема:** Жестко закодированный пароль для пользователя `postgres`.
- **Рекомендация:** Использовать переменные окружения или другой безопасный механизм для установки пароля.

- **Строка:** 1-8
- **Критичность:** Высокая
- **Проблема:** Скрипт использует `sudo` и устанавливает `postgresql` непосредственно на хост-машину, что противоречит идее использования Docker для изоляции окружения.
- **Рекомендация:** Удалить этот скрипт. Вся настройка баз данных должна производиться через `docker-compose.yml` и, при необходимости, через скрипты инициализации, которые запускаются внутри контейнеров PostgreSQL.

### api_gateway/nginx.conf
- **Строка:** 30, 50, 70, 90, 110
- **Критичность:** Низкая
- **Проблема:** Дублирование заголовков CORS в каждом `location` блоке.
- **Рекомендация:** Вынести общие заголовки CORS в блок `server` для уменьшения дублирования и упрощения конфигурации.

- **Строка:** 10
- **Критичность:** Средняя
- **Проблема:** `map $http_origin $cors_origin` разрешает любой источник, что может быть небезопасно.
- **Рекомендация:** Создать "белый список" доверенных доменов, чтобы ограничить доступ к API.

### user_service/app/main.py
- **Строка:** 28
- **Критичность:** Низкая
- **Проблема:** Отсутствие валидации сложности пароля при создании пользователя.
- **Рекомендация:** Добавить валидацию сложности пароля, например, с использованием регулярных выражений или библиотеки, такой как `passlib`.

- **Строка:** 90
- **Критичность:** Высокая
- **Проблема:** Эндпоинт `PATCH /users/{user_id}/wallet` не имеет авторизации. Любой пользователь может изменить баланс кошелька другого пользователя, зная его ID.
- **Рекомендация:** Добавить проверку прав доступа. Только администраторы или сам пользователь (в зависимости от бизнес-логики) должны иметь возможность изменять баланс кошелька.

### bets_service/app/main.py
- **Строка:** 45-78
- **Критичность:** Высокая
- **Проблема:** Отсутствие атомарности операции создания ставки. Если после создания ставки в базе данных (`crud.create_bet`) произойдет сбой при обновлении баланса кошелька, система останется в несогласованном состоянии (ставка есть, а деньги не списаны).
- **Рекомендация:** Реализовать транзакционность для всей операции. Если какая-либо часть операции завершается неудачно, все изменения должны быть отменены.

- **Строка:** 81
- **Критичность:** Средняя
- **Проблема:** Эндпоинт `GET /bets/` не имеет пагинации, что может привести к проблемам с производительностью при большом количестве ставок.
- **Рекомендация:** Добавить параметры `skip` и `limit` для пагинации результатов.

### matches_service/app/main.py
- **Строка:** 66, 80
- **Критичность:** Средняя
- **Проблема:** Общая обработка исключений (`except Exception as e`) скрывает реальные причины ошибок и возвращает общее сообщение "Internal server error".
- **Рекомендация:** Добавить более специфичную обработку ошибок, чтобы возвращать осмысленные сообщения об ошибках и логировать детали для отладки.

- **Строка:** 32
- **Критичность:** Средняя
- **Проблема:** Отсутствие пагинации для эндпоинта `GET /matches/`.
- **Рекомендация:** Добавить параметры `skip` и `limit` для пагинации.

### teams_service/app/main.py
- **Строка:** 36
- **Критичность:** Низкая
- **Проблема:** При создании команды (`create_team`) возвращается `None` в случае, если команда с таким именем уже существует, и затем в эндпоинте генерируется исключение `HTTPException`.
- **Рекомендация:** Переместить проверку на существование команды и генерацию исключения в `crud` слой, чтобы сделать код более чистым и соответствующим принципу единственной ответственности (Single Responsibility Principle).

- **Строка:** 58
- **Критичность:** Средняя
- **Проблема:** Отсутствие защиты от удаления команды, которая участвует в матчах.
- **Рекомендация:** Добавить проверку, что команда не связана с какими-либо матчами, перед ее удалением.
